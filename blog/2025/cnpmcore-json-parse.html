<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="description" content="MK2's blogï¼Œç”Ÿå‘½æ˜¯ä¸€åœºå¹»è§‰ï¼Œä»£ç æ˜¯ä¸€æ®µäººç”Ÿã€‚">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://registry.npmmirror.com/typo.css/1/files/typo.css">
  <link rel="stylesheet" href="https://registry.npmmirror.com/bootstrap/3/files/dist/css/bootstrap.min.css">
  <link rel="stylesheet" href="https://registry.npmmirror.com/bootstrap/3/files/dist/css/bootstrap-theme.min.css">
  <link rel="stylesheet" href="/css/prettify.css">
  <link rel="stylesheet" href="/css/mk2.css">
  <title>cnpmcore è¶…å¤§ JSON ååºåˆ—åŒ–æ€§èƒ½ä¼˜åŒ–</title>
</head>
<body>

<div id="wrapper" class="typo">

<div id="header">
<h3><a href="/">Home</a> | <a href="../index.html">Prev</a></h3>
</div> <!-- #header -->

<div id="content">
<h1 id="cnpmcore-è¶…å¤§-json-ååºåˆ—åŒ–æ€§èƒ½ä¼˜åŒ–">cnpmcore è¶…å¤§ JSON ååºåˆ—åŒ–æ€§èƒ½ä¼˜åŒ–</h1>
<h2 id="é—®é¢˜">é—®é¢˜</h2>
<p>npmmirror registry ä¸Šå¶å°”ä¼š CPU ç‹‚é£™ä¸€ä¼šï¼Œçœ‹æ—¥å¿—å‘ç°è¿™ä¸ªæ—¶é—´æ®µå†…æœ‰ä¸€ä¸ªè¶…å¤šç‰ˆæœ¬çš„ npm åŒ…åœ¨åŒæ­¥ï¼Œå¦‚ <a href="https://www.npmjs.com/package/@primer/react">@primer/react</a>ã€‚<br>æœ€ç»ˆå‘ç°è¿™ä¸ª npm åŒ…çš„ full manifests JSON æ–‡ä»¶æ•°æ®æœ‰ 89MBï¼Œå¯¹å®ƒè¿›è¡Œ JSON ååºåˆ—åŒ–å Node.js è¿›ç¨‹å ç”¨çš„å†…å­˜é«˜è¾¾ 760MBã€‚å¯è§è¿™ä¸ªè¿‡ç¨‹ä¸­åˆ›å»ºäº†éå¸¸å¤šçš„ JavaScript Objectsï¼Œå¹¶ä¸”åœ¨ npmmirror çš„åŒæ­¥åœºæ™¯ä¸­ï¼Œè¿™äº› versions æ•°æ®ç»å¤§éƒ¨åˆ†éƒ½æ˜¯å¤šä½™çš„ï¼Œå¹¶ä¸ä¼šè¢«ä½¿ç”¨åˆ°ã€‚</p>
<p>æ‰€ä»¥é—®é¢˜æ¥äº†ï¼Œæ€æ ·æ‰èƒ½åšåˆ°æŒ‰éœ€è¯»å–éœ€è¦åŒæ­¥çš„ versions æ•°æ®ï¼Œè€Œåˆä¸éœ€è¦æå‰ååºåˆ—åŒ–æ•´ä¸ª JSON æ•°æ®ã€‚</p>
<blockquote>
<p>é€šè¿‡ JSON.parse è¯»å– 22MB å’Œ 89MB æ•°æ®åçš„ Node.js è¿›ç¨‹çš„å†…å­˜å ç”¨å¯¹æ¯”ï¼ˆ<a href="https://github.com/cnpm/packument/blob/master/benchmark/get_property_value.ts">æµ‹è¯•è„šæœ¬</a>ï¼‰</p>
</blockquote>
<pre><code class="language-bash">Memory Usage:
  JSONParse get property value (22M): 490.4 MB (min: 490.0 MB, max: 490.9 MB)
  JSONParse get property value (89M): 796.2 MB (min: 766.1 MB, max: 871.4 MB)
</code></pre>
<h2 id="æ€è·¯">æ€è·¯</h2>
<p>è¿™ä¸ªé—®é¢˜å·²ç»å›°æ‰° cnpmcore å¥½å¤šå¹´ï¼Œç¬¬ä¸€æ¬¡å°è¯•æ˜¯åœ¨ 2023 å¹´é—®é¢˜é›†ä¸­çˆ†å‘çš„é‚£æ®µæ—¶é—´é‡Œï¼Œæ›¾ç»æƒ³è¿‡ä½¿ç”¨ <a href="https://github.com/cnpm/cnpmcore/issues/564#issuecomment-1864694766">streamparser-json</a> æ¥é‡æ„ï¼Œå‘ç°è¦å˜æ›´ä½¿ç”¨æ–¹å¼å¯¼è‡´ä»£ç æ”¹åŠ¨é‡è¿˜æ˜¯æŒºå¤§çš„ï¼Œæ—¶é—´æˆæœ¬å’Œå¤æ‚åº¦å¤ªé«˜ä¸­é€”è€ŒåºŸäº†ã€‚<br>ç¬¬äºŒæ¬¡å°è¯•æ˜¯ 2024 å¹´åˆå¶ç„¶çœ‹åˆ° <a href="https://github.com/cnpm/cnpmcore/issues/655">simdjson_nodejs</a> è¿™ä¸ª C++ æ‰©å±•ï¼Œå°è¯•å‡ å¤©åå‘ç°è·¨å¹³å°ç¼–è¯‘å¾ˆéº»çƒ¦è€Œæˆ‘åˆä¸æƒ³æŠ˜è…¾æ¯•ç«Ÿæˆ‘ä»¬æ¯å¹´éƒ½è¿˜å¾—å‡çº§ Node.js ç‰ˆæœ¬ï¼Œäºæ˜¯åˆä¸­æ–­äº†ã€‚<br>æœ€åä¸€æ¬¡å°è¯•æ˜¯ 2025 å¹´ 11 æœˆè‡ªå·±å­¦ä¹  Rust + simd-json è¿‡ç¨‹ä¸­å‘ç°å¯ä»¥ç»“åˆ napi-rs å®ç°ä¸€ä¸ªæŒ‰éœ€è§£æ JSON çš„å·§å¦™æ–¹æ³•ã€‚åœ¨<a href="https://github.com/Brooooooklyn">@Brooooooklyn</a> çš„æŒ‡å¯¼ä¸‹å­¦ä¼šäº† zero-copy çš„æ–¹å¼è®© Node.js ä¸ Rust ä¹‹é—´äº¤æ¢æ•°æ®ï¼Œæœ€ç»ˆé€‰æ‹©åœ¨ <a href="https://github.com/cloudwego/sonic-rs">sonic-rs</a> ä¸Šå®ç°äº†ä¸€ä¸ª <a href="https://github.com/npm/registry/blob/main/docs/REGISTRY-API.md#getpackage">npm full manifests</a> JSON ä¸“ä¸šçš„è§£æåº“ <a href="https://github.com/cnpm/packument">@cnpmjs/packument</a> ï¼Œåªéœ€è¦ä¼ é€’ JSON Buffer å¼•ç”¨å’Œå½“å‰ç‰ˆæœ¬å·æ•°ç»„ç»™ diff å‡½æ•°ï¼Œå®ƒå°±èƒ½æŒ‰éœ€è®¡ç®—å‡ºå·®å¼‚çš„ç‰ˆæœ¬ä¿¡æ¯ä»¥åŠè¯¥ç‰ˆæœ¬åœ¨ Buffer æ•°æ®ä¸­çš„åç§»é‡ä½ç½®ï¼Œç„¶å cnpmcore æŒ‰éœ€ååºåˆ—åŒ–ç›¸å¯¹åº”çš„ versions æ•°æ®ï¼Œè¿™æ ·æœ€ç»ˆçš„ JavaScript Objects ç”Ÿæˆé‡ä¼šå¤§å¤§å‡å°‘ã€‚</p>
<p>ç¤ºæ„ä»£ç å¦‚ä¸‹ï¼š</p>
<pre><code class="language-typescript">import { Package } from &#39;@cnpmjs/packument&#39;
import { readFileSync } from &#39;fs&#39;

// Prepare local and remote package data
const localVersions = [&#39;1.0.0&#39;, &#39;1.0.1&#39;, &#39;1.0.2&#39;]
const remoteBuffer = readFileSync(&#39;path/to/remote-packument.json&#39;)

// Create remote package instance
const remotePkg = new Package(remoteBuffer)

// Find the diff
const diff = remotePkg.diff(localVersions)

console.log(diff.addedVersions) // Versions in remote but not in local
console.log(diff.removedVersions) // Versions in local but not in remote

// Example output:
// {
//   addedVersions: [
//     [&#39;1.1.0&#39;, [100992, 119796]],  // [version, [startPos, endPos]]
//     [&#39;1.2.0&#39;, [119797, 138592]],
//   ],
//   removedVersions: [
//     &#39;1.0.1&#39;,  // This version exists in local but not in remote
//   ]
// }
</code></pre>
<p>é‡æ–°è·‘ä¸€ä¸‹ JSON ååºåˆ—åŒ–å†…å­˜å ç”¨çš„<a href="https://github.com/cnpm/packument/blob/master/benchmark/get_property_value.ts">æµ‹è¯•è„šæœ¬</a>ï¼Œå¯ä»¥çœ‹åˆ°åŸºäº snoic-rs çš„å†…å­˜å ç”¨è¿œå°äº JSON.parseï¼Œå¹¶æ‰“å¼€ V8 GC ç›‘æ§å¯ä»¥çœ‹åˆ° scavenge ä» 200ms ç›´æ¥ä¸‹é™ä¸º 0msï¼Œä»£è¡¨è¿™ä¸ªè¿‡ç¨‹ä¸­æ²¡æœ‰ç”Ÿæˆæ— ç”¨çš„ JS å¯¹è±¡ã€‚</p>
<pre><code class="language-bash">Memory Usage:
  JSONParse get property value (22M): 490.4 MB (min: 490.0 MB, max: 490.9 MB)
  JSONParse get property value (89M): 796.2 MB (min: 766.1 MB, max: 871.4 MB)
  SonicJSONParse get property value (22M): 93.1 MB (min: 92.1 MB, max: 94.1 MB)
  SonicJSONParse get property value (89M): 159.7 MB (min: 158.9 MB, max: 160.6 MB)

## Benchmarking JSONParse with @primer/react.json
- Data size: 89MB
- GC: enabled

JSONParse get name of @primer/react.json: &#39;@primer/react&#39;
JSONParse get property value (@primer/react.json) #1 time: 431ms
JSONParse get property value (@primer/react.json) #2 time: 408ms
JSONParse get property value (@primer/react.json) #3 time: 430ms
JSONParse get property value (@primer/react.json) #4 time: 374ms
JSONParse get property value (@primer/react.json) #5 time: 375ms

[GC] total(ms)= 243.99 count= 26 avg(ms)= 9.38 byKind= {
  scavenge: 209.25045899994439,
  markSweepCompact: 33.537017999915406,
  incremental: 1.2019700000528246,
  weakc: 0,
  unknown: 0
}

## Benchmarking SonicJSONParse with @primer/react.json
- Data size: 89MB
- GC: enabled

SonicJSONParse get name of @primer/react.json: &#39;@primer/react&#39;
SonicJSONParse get property value (@primer/react.json) #1 time: 0ms
SonicJSONParse get property value (@primer/react.json) #2 time: 0ms
SonicJSONParse get property value (@primer/react.json) #3 time: 0ms
SonicJSONParse get property value (@primer/react.json) #4 time: 0ms
SonicJSONParse get property value (@primer/react.json) #5 time: 0ms

[GC] total(ms)= 1.81 count= 2 avg(ms)= 0.90 byKind= {
  scavenge: 0,
  markSweepCompact: 1.6087210000259802,
  incremental: 0.19731899996986613,
  weakc: 0,
  unknown: 0
}
</code></pre>
<h2 id="å‘å¸ƒ">å‘å¸ƒ</h2>
<p>å°† packument åˆå¹¶åˆ° <a href="https://github.com/cnpm/cnpmcore/pull/905">cnpmcore#905</a> åï¼Œæ‰¾ <a href="https://github.com/elrrrrrrr">@elrrrrrrr</a> å“¥å“¥å¸®å¿™å…ˆåœ¨ <a href="https://r.cnpmjs.org/">r.cnpmjs.org</a> ä¸Šç°åº¦äº† 1 å‘¨éªŒè¯æ²¡æœ‰ç¨³å®šæ€§é—®é¢˜åï¼Œç»ˆäºåœ¨ 2025 å¹´çš„æœ€åä¸€ä¸ªæœˆå‘å¸ƒåˆ° <a href="https://registry.npmmirror.com/">npmmirror registry</a>ï¼Œæ€»ç®—å°†è‡ªå·±ç•™ä¸‹çš„ä¸€ä¸ªå·¨å‘ç»™å¡«ä¸Šã€‚</p>
<h2 id="æ•ˆæœéªŒè¯">æ•ˆæœéªŒè¯</h2>
<h3 id="å·¨å‹-npm-åŒ…å¯ä»¥é¡ºåˆ©åŒæ­¥">å·¨å‹ npm åŒ…å¯ä»¥é¡ºåˆ©åŒæ­¥</h3>
<p>å¦‚ <a href="https://www.npmjs.com/package/carrot-scan?activeTab=versions">carrot-scan</a> è¿™ä¸ªæ‹¥æœ‰ 27550 ä¸ªç‰ˆæœ¬çš„ npm åŒ…ä¹‹å‰ä¸€ç›´æ— æ³•åŒæ­¥æˆåŠŸï¼Œè¿™æ¬¡æ›´æ–°åå°±èƒ½åœ¨ 159ms å†…è®¡ç®—å‡º diff å¹¶é¡ºåˆ©åŒæ­¥å®Œæˆã€‚</p>
<p>å°±ç®— npm registry æ¥å£æœªæ¥å‡ å¹´éƒ½ä¸æ‰“ç®—è§£å†³å•åŒ…ç‰ˆæœ¬æ— é™å¢é•¿é—®é¢˜ï¼Œcnpmcore çš„åŒæ­¥æœºåˆ¶ä¾æ—§å¯ä»¥æŒç»­è¿è¡Œã€‚</p>
<p>å¦‚æœä¸‡ä¸€çœŸçš„æœ‰ä¸€å¤©å•åŒ…çš„å…¨é‡ full manifests æ•°æ®è¶…è¿‡å•è¿›ç¨‹å†…å­˜ä¸Šé™ğŸ˜¨ï¼Œé‚£ä¹ˆå°±å¾—ç»§ç»­åšæŠ€æœ¯æ–¹æ¡ˆé‡æ„äº†ï¼ˆçœŸçš„æœ‰è¿™ä¸€å¤©ï¼Œä¼°è®¡ npm install ä¹Ÿæ— æ³•æ­£å¸¸å·¥ä½œäº†ï¼‰ã€‚</p>
<pre><code class="language-bash">[2025-12-09T01:28:42.590Z] HTTP [200] body size: 108866043, timing: {&quot;queuing&quot;:0.126,&quot;dnslookup&quot;:0,&quot;connected&quot;:0,&quot;requestHeadersSent&quot;:0.159,&quot;requestSent&quot;:0.208,&quot;waiting&quot;:1430.597,&quot;contentDownload&quot;:11589.122}
[2025-12-09T01:28:43.408Z] ğŸš§ Syncing versions 27550 =&gt; 27708, 158 added, 0 removed, calculate diff use 159ms
</code></pre>
<blockquote>
<p><a href="https://github.com/cnpm/cnpmcore/issues/900#issuecomment-3629797553">https://github.com/cnpm/cnpmcore/issues/900#issuecomment-3629797553</a></p>
</blockquote>
<h3 id="ezm-ç›‘æ§æ•°æ®å¯¹æ¯”çœ‹åˆ°æ•´ä½“æ€§æœ‰æå‡">EZM ç›‘æ§æ•°æ®å¯¹æ¯”çœ‹åˆ°æ•´ä½“æ€§æœ‰æå‡</h3>
<p>cnpmcore v4.14.0 å‘å¸ƒåˆ° <a href="https://registry.npmmirror.com/">registry.npmmirror.com</a> çš„ EZM ç›‘æ§å¯¹æ¯”ï¼š</p>
<p>Scavenge GC æ˜æ˜¾å‡å°‘äº†è®¸å¤šï¼Œä»£è¡¨ä¸´æ—¶ç”Ÿæˆçš„ JSON ååºåˆ—åŒ–å¯¹è±¡ç¡®å®å˜å°‘äº†ã€‚</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/84137/1765280648848-7507779d-0a09-4935-98fc-f62154ebdebc.png" alt=""></p>
<p>CPUã€GCã€QPS çš„å¯¹æ¯”ï¼Œæ›´é«˜çš„ QPS å³°å€¼ CPU æ›´ä½äº†</p>
<p><img src="https://cdn.nlark.com/yuque/0/2025/png/84137/1765280591329-ff8e3d2a-c711-4b65-8c79-6d931f7c994d.png" alt=""></p>
<h3 id="å‡çº§åçš„-cpu-profile-åˆ†ææŠ¥å‘Š">å‡çº§åçš„ CPU Profile åˆ†ææŠ¥å‘Š</h3>
<p>å¯¹æ¯” <a href="https://github.com/cnpm/cnpmcore/blob/profiler-20251208-4.12.0/benchmark/profiler-4.12.0/REPORT.md#application-code-hotspots">v4.12.0</a> å’Œ <a href="https://github.com/cnpm/cnpmcore/blob/profiler-20251209-4.14.0/benchmark/profiler-4.14.0/ANALYSIS-REPORT.md#cnpmcore-application-code-analysis">v4.14.0</a> çš„ cpuprofile ä¸­å…³äºåº”ç”¨å±‚çƒ­ç‚¹ä»£ç åˆ†æï¼Œå¯ä»¥çœ‹åˆ° JSON ååºåˆ—åŒ–ç›¸å…³çƒ­ç‚¹ä»£ç å·²ç»ä¸è§äº†ï¼Œä»£è¡¨æ€§èƒ½ä¼˜åŒ–ç¬¦åˆé¢„æœŸã€‚</p>
<blockquote>
<p>åç»­ cnpmcore æ¯æ¬¡å‘å¸ƒåéƒ½ä¼šåšä¸€ä¸‹ CPU Profile åˆ†ææŠ¥å‘Šï¼Œå¹¶æ”¾åœ¨ <a href="https://github.com/cnpm/cnpmcore/wiki#performance">https://github.com/cnpm/cnpmcore/wiki#performance</a> Wiki ä¸‹ï¼Œæ¬¢è¿å‚è€ƒä½¿ç”¨ã€‚</p>
</blockquote>
<h2 id="æœ‰çˆ±">æœ‰çˆ±</h2>
<p>å¸Œæœ›æœ¬æ–‡å¯¹ä½ æœ‰ç”¨ ğŸ’—</p>


<h2>Comments</h2>
<div id="disqus_thread"></div>
<script>
    /**
    *  RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
    *  LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables    */
    /*
    var disqus_config = function () {
    this.page.url = PAGE_URL;  // Replace PAGE_URL with your page's canonical URL variable
    this.page.identifier = PAGE_IDENTIFIER; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
    };
    */
    (function() { // DON'T EDIT BELOW THIS LINE
    var d = document, s = d.createElement('script');
    s.src = 'https://fengmk2github.disqus.com/embed.js';
    s.setAttribute('data-timestamp', +new Date());
    (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<script id="dsq-count-scr" src="//fengmk2github.disqus.com/count.js" async></script>

</div> <!-- #content -->

<div id="footer">
</div> <!-- #footer -->

</div> <!-- #wrapper -->

<a href="https://github.com/fengmk2" id="fork">
  <img alt="Fork me on GitHub" src="/images/forkme_right_green.png">
</a>

<!-- Specific to this page -->
<script src="https://registry.npmmirror.com/jquery/2/files/dist/jquery.min.js"></script>
<script src="https://registry.npmmirror.com/bootstrap/3/files/dist/js/bootstrap.min.js"></script>
<script src="/js/prettify.js"></script>
<script>
$(function() {
  $('pre code').parent().addClass('prettyprint');
  prettyPrint();
});
</script>
</body>
</html>

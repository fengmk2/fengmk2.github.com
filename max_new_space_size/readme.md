# max_new_space_size 参数调整

https://gist.github.com/fengmk2/7395406

## trace_gc_verbose 按总 gc 时间统计

重点关注 `New space` 的 `available` 是否一直在变化, 如果应用超过了这个值, 那么就需要将 `max_new_space_size` 调大

max_new_space_size 必须按 16MB, 32MB, 64MB, 128MB, 256MB 步长递增才有效.

```
[8223] New space,          used:      0 KB, available: 131072 KB, committed: 262144 KB
```

### 并发2, 压测 15s, node 进程占用内存 135 MB

```
$ ./ab -t 15 -c 2 -k '127.0.0.1:7001/'
```

size | gc time | qps | rt
--- | --- | --- | ---
10240 | 567.5 | 1283.58 | 1.558
20480 | 574.7 | 1237.98 | 1.616
32768 (默认) | 554.6 | 1236.95 | 1.617
65536 | 484.3 | 1291.73 | 1.548
81920 | 342.7 | 1341.85 | 1.490
92160 | 358.5 | 1263.66 | 1.583
102400 | 362.7 | 1308.52 | 1.528
122880 | 341.9 | 1301.96 | 1.536
153600 | 351.2 | 1256.35 | 1.592
204800 | 344.8 | 1256.52 | 1.592

### 并发10, 压测 30s, node 进程占用内存 93MB

```
$ ./ab -t 30 -c 10 -k '127.0.0.1:7001/'
```

size | gc time | qps | rt
--- | --- | --- | ---
20480 | 1076.6 | 1595.43 | 6.268
25600 | 1050.2 | 1523.93 | 6.562
30720 | 1054.5 | 1522.61 | 6.568
32768 (默认) | 1075.7 | 1586.33 | 6.304
40960 | 1025.1 | 1619.56 | 6.175
51200 | 932.2 | 1562.26 | 6.401
65536 | 571.8 | 1530.07 | 6.536
81920 | 534.0 | 1656.32 | 6.037
92160 | 536.4 | 1560.68 | 6.407
97280 (95MB) | 524.3 | 1594.59 | 6.271
102400 | 527.8 | 1575.34 | 6.348
122880 | 537.4 | 1586.04 | 6.305
153600 | 544.7 | 1618.33 | 6.179
204800 | 520.4 | 1569.66 | 6.371
256000 | 519.6 | 1552.86 | 6.440
131072 | 
